<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NSSA Tools</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=design_services" />
  <script src="/firebase-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="/js/user-storage.js"></script>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="border-b bg-white">
    <div class="mx-auto max-w-5xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">NSSA Tools</h1>
      <div class="text-sm flex items-center gap-3">
        <span id="user-email" class="text-slate-500"></span>
        <a id="login-open" href="#" class="text-blue-600 hover:text-blue-700 hidden">登录</a>
        <a id="logout-link" href="/auth/logout" class="text-blue-600 hover:text-blue-700 hidden">退出</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-5xl px-4 py-10">
    <p class="text-slate-600 mb-6">请选择一个工具进入：</p>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <a href="/mlg" data-target="/mlg" data-require-auth="false" class="tool-card block group rounded-xl border bg-white p-6 shadow-sm hover:shadow-md transition">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">哈吉喵</h2>
          <span class="text-blue-600 group-hover:translate-x-0.5 transition">→</span>
        </div>
        <p class="mt-2 text-sm text-slate-500">初始 8 关，每 3 关提升难度；预留“扩容 x2”道具。</p>
      </a>

      <a href="/cron" data-target="/cron" data-require-auth="true" class="tool-card block group rounded-xl border bg-white p-6 shadow-sm hover:shadow-md transition">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Webhook 定时任务</h2>
          <span class="text-blue-600 group-hover:translate-x-0.5 transition">→</span>
        </div>
        <p class="mt-2 text-sm text-slate-500">创建并在浏览器中调度 Webhook 请求（邮箱密码登录，管理员创建账号）。</p>
      </a>

      <a href="/Gomoku" data-target="/Gomoku" data-require-auth="false" class="tool-card block group rounded-xl border bg-white p-6 shadow-sm hover:shadow-md transition">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">五子棋</h2>
          <span class="text-blue-600 group-hover:translate-x-0.5 transition">→</span>
        </div>
        <p class="mt-2 text-sm text-slate-500">人机/双人对战，支持游客模式，登录后可保存战绩。</p>
      </a>

      <a href="https://topfac.nssa.io" target="_blank" rel="noreferrer noopener" class="block group rounded-xl border bg-white p-6 shadow-sm hover:shadow-md transition">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">智能网络拓扑生成系统</h2>
          <span class="text-blue-600 group-hover:translate-x-0.5 transition">↗</span>
        </div>
        <p class="mt-2 text-sm text-slate-500">基于自然语言描述生成网络拓扑图，支持 DrawIO 格式输出。</p>
      </a>
    </div>
  </main>

  <!-- 登录弹窗 -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="w-full max-w-sm bg-white rounded-xl shadow p-6 space-y-4">
      <div>
        <h2 class="text-xl font-semibold text-slate-800">登录 NSSA Tools</h2>
        <p class="text-sm text-slate-500">使用邮箱和密码登录。无自助注册。</p>
      </div>
      <div class="space-y-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">邮箱</label>
          <input id="login-email" type="email" class="w-full border rounded px-3 py-2" placeholder="you@example.com" />
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">密码</label>
          <input id="login-password" type="password" class="w-full border rounded px-3 py-2" placeholder="******" />
        </div>
        <p id="login-error" class="text-sm text-red-600"></p>
        <div class="flex gap-2">
          <button id="login-submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded py-2">登录</button>
          <button id="login-cancel" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold rounded py-2">取消</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      // 使用 Material Symbols 生成动态 favicon
      function setFavicon() {
        try {
          var size = 64;
          var canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          var ctx = canvas.getContext('2d');
          var draw = function() {
            ctx.clearRect(0,0,size,size);
            ctx.fillStyle = '#0a84ff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '48px "Material Symbols Outlined"';
            ctx.fillText('design_services', size/2, size/2 + 2);
            var url = canvas.toDataURL('image/png');
            var link = document.querySelector('link[rel="icon"][data-dynamic="1"]');
            if (!link) { link = document.createElement('link'); link.rel='icon'; link.type='image/png'; link.setAttribute('data-dynamic','1'); document.head.appendChild(link); }
            link.href = url;
          };
          if (document.fonts && document.fonts.load) {
            document.fonts.load('48px "Material Symbols Outlined"').then(draw, draw);
          } else {
            setTimeout(draw, 300);
          }
        } catch(e) {}
      }

      // 会话预热：若带有 redirect 参数，确保已登录后再跳转，减少受保护页面的首跳 302
      function handleRedirectAfterWarmup() {
        var params = new URLSearchParams(window.location.search);
        var target = params.get('redirect');
        if (!target) return;
        if (!window.__FIREBASE_CONFIG__ || !window.firebase) {
          // 若 Firebase 尚未就绪，稍后再检查
          setTimeout(handleRedirectAfterWarmup, 50);
          return;
        }
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(window.__FIREBASE_CONFIG__);
        }
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // 已登录，跳转到目标页
            window.location.replace(target);
          }
        });
      }

      var currentUser = null;
      function persistSessionToWorker(idToken){
        return fetch('/auth/session', { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify({ idToken }) });
      }

      function openLoginModal(target){
        var modal = document.getElementById('login-modal');
        var emailEl = document.getElementById('login-email');
        var pwdEl = document.getElementById('login-password');
        var errEl = document.getElementById('login-error');
        var submitting = false;
        errEl.textContent = '';
        modal.classList.remove('hidden');

        function close(){ modal.classList.add('hidden'); }
        document.getElementById('login-cancel').onclick = close;
        document.getElementById('login-submit').onclick = async function(){
          if (submitting) return; submitting = true; errEl.textContent = '';
          try{
            const auth = firebase.auth();
            await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
            const cred = await auth.signInWithEmailAndPassword(emailEl.value, pwdEl.value);
            const idToken = await cred.user.getIdToken(true);
            await persistSessionToWorker(idToken);
            close();
            window.location.href = target;
          }catch(e){ errEl.textContent = e.message || '登录失败'; }
          finally{ submitting = false; }
        };
      }

      function bindToolCards(){
        document.querySelectorAll('a.tool-card[data-require-auth="true"]').forEach(function(a){
          a.addEventListener('click', function(e){
            var target = a.getAttribute('data-target') || a.getAttribute('href');
            if (!currentUser){ e.preventDefault(); openLoginModal(target); }
          });
        });
      }

      function bindAuthLinks(){
        var loginOpen = document.getElementById('login-open');
        var logoutLink = document.getElementById('logout-link');
        if (loginOpen){
          loginOpen.addEventListener('click', function(e){
            e.preventDefault();
            openLoginModal('/');
          });
        }
        if (logoutLink){
          logoutLink.addEventListener('click', async function(e){
            e.preventDefault();
            try{
              if (window.firebase && firebase.apps && firebase.apps.length){
                await firebase.auth().signOut();
              }
            }catch(e){}
            // 清 Cookie 会话
            window.location.href = '/auth/logout';
          });
        }
      }

      if (window.__FIREBASE_CONFIG__) {
        if (!firebase.apps || firebase.apps.length === 0) {
          firebase.initializeApp(window.__FIREBASE_CONFIG__);
        }
        firebase.auth().onAuthStateChanged(async function(user) {
          currentUser = user || null;
          var emailEl = document.getElementById('user-email');
          var loginOpen = document.getElementById('login-open');
          var logoutLink = document.getElementById('logout-link');
          if (emailEl) emailEl.textContent = currentUser ? (currentUser.email || '') : '';
          if (currentUser){
            if (logoutLink) logoutLink.classList.remove('hidden');
            if (loginOpen) loginOpen.classList.add('hidden');
            try{ const idToken = await currentUser.getIdToken(true); await persistSessionToWorker(idToken); }catch(e){}
          } else {
            if (logoutLink) logoutLink.classList.add('hidden');
            if (loginOpen) loginOpen.classList.remove('hidden');
          }
          // 登录后尝试处理预热跳转
          handleRedirectAfterWarmup();
          // 设置 favicon
          setFavicon();
        });
        bindToolCards();
        bindAuthLinks();
      }
    })();
  </script>
</body>
</html>
