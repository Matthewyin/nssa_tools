<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLG æ‰‹æœºç«¯è°ƒè¯•</title>
  <style>
    body { font-family: monospace; padding: 10px; background: #f5f5f5; margin: 0; font-size: 12px; }
    .debug-panel { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .error { background: #f8d7da; color: #721c24; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .success { background: #d4edda; color: #155724; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .warning { background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; margin: 5px 0; }
    button { padding: 6px 12px; margin: 3px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .btn-test { background: #007acc; color: white; }
    .btn-open { background: #28a745; color: white; }
    .btn-refresh { background: #ffc107; color: black; }
    pre { background: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 10px; }
    .device-info { background: #e3f2fd; padding: 8px; border-radius: 4px; margin: 5px 0; }
    iframe { width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="debug-panel">
    <h2>ğŸ“± MLG æ‰‹æœºç«¯è°ƒè¯•é¢æ¿</h2>
    <div class="device-info" id="device-info">è®¾å¤‡ä¿¡æ¯åŠ è½½ä¸­...</div>
    
    <div style="text-align: center; margin: 10px 0;">
      <button class="btn-test" onclick="runDiagnostics()">è¿è¡Œè¯Šæ–­</button>
      <button class="btn-open" onclick="openGame()">æ‰“å¼€æ¸¸æˆ</button>
      <button class="btn-refresh" onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
    </div>
    
    <div id="diagnostics-result"></div>
  </div>

  <div class="debug-panel">
    <h3>ğŸ® æ¸¸æˆé¢„è§ˆ</h3>
    <iframe src="/mlg/" id="game-iframe"></iframe>
    <div class="info">
      <strong>æ£€æŸ¥è¦ç‚¹ï¼š</strong><br>
      â€¢ æ˜¯å¦èƒ½çœ‹åˆ°ç«‹æ–¹ä½“<br>
      â€¢ ç«‹æ–¹ä½“å¤§å°æ˜¯å¦åˆé€‚<br>
      â€¢ æ˜¯å¦æœ‰JavaScripté”™è¯¯<br>
      â€¢ æ§åˆ¶å°æ˜¯å¦æœ‰è°ƒè¯•ä¿¡æ¯
    </div>
  </div>

  <div class="debug-panel">
    <h3>ğŸ“Š æ§åˆ¶å°æ—¥å¿—</h3>
    <div class="warning">
      <strong>æŸ¥çœ‹æ§åˆ¶å°ï¼š</strong><br>
      1. åœ¨æ‰‹æœºæµè§ˆå™¨ä¸­æ‰“å¼€å¼€å‘è€…å·¥å…·<br>
      2. æŸ¥çœ‹Consoleæ ‡ç­¾é¡µ<br>
      3. å¯»æ‰¾"åŠ¨æ€ç¼©æ”¾è¯¦æƒ…"æ—¥å¿—<br>
      4. æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
    </div>
    <div id="console-logs"></div>
  </div>

  <div class="debug-panel">
    <h3>ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥</h3>
    <div class="info">
      <strong>å¯èƒ½çš„é—®é¢˜ï¼š</strong><br>
      1. <strong>ç”»å¸ƒå°ºå¯¸é—®é¢˜</strong>ï¼šç”»å¸ƒå®½åº¦æˆ–é«˜åº¦ä¸º0<br>
      2. <strong>ç¼©æ”¾è®¡ç®—é”™è¯¯</strong>ï¼šç«‹æ–¹ä½“å¤§å°è®¡ç®—ä¸º0æˆ–è´Ÿæ•°<br>
      3. <strong>çŸ©å½¢ä¿¡æ¯ç¼ºå¤±</strong>ï¼šcomputeTileRectsè¿”å›ç©ºå€¼<br>
      4. <strong>æ¸²æŸ“ä¸Šä¸‹æ–‡é—®é¢˜</strong>ï¼šCanvas 2Dä¸Šä¸‹æ–‡è·å–å¤±è´¥<br>
      5. <strong>CSSæ ·å¼å†²çª</strong>ï¼šç”»å¸ƒè¢«éšè—æˆ–é®æŒ¡<br><br>
      
      <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
      â€¢ æ£€æŸ¥æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯<br>
      â€¢ ç¡®è®¤ç”»å¸ƒå°ºå¯¸æ­£å¸¸<br>
      â€¢ éªŒè¯ç¼©æ”¾è®¡ç®—ç»“æœ<br>
      â€¢ æ£€æŸ¥ç«‹æ–¹ä½“æ•°é‡å’Œä½ç½®
    </div>
  </div>

  <script>
    // è®¾å¤‡ä¿¡æ¯æ£€æµ‹
    function updateDeviceInfo() {
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      const devicePixelRatio = window.devicePixelRatio || 1;
      const userAgent = navigator.userAgent;
      
      let deviceType = 'Unknown';
      if (screenWidth <= 480) {
        deviceType = 'è¶…å°å±æ‰‹æœº';
      } else if (screenWidth <= 640) {
        deviceType = 'å°å±æ‰‹æœº';
      } else if (screenWidth <= 768) {
        deviceType = 'å¤§å±æ‰‹æœº/å¹³æ¿ç«–å±';
      } else {
        deviceType = 'PCç«¯/å¹³æ¿æ¨ªå±';
      }
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
      const isAndroid = /Android/i.test(userAgent);
      
      document.getElementById('device-info').innerHTML = `
        <strong>è®¾å¤‡ä¿¡æ¯ï¼š</strong><br>
        ğŸ“± ç±»å‹ï¼š${deviceType}<br>
        ğŸ“ å±å¹•ï¼š${screenWidth} Ã— ${screenHeight}px<br>
        ğŸ” åƒç´ æ¯”ï¼š${devicePixelRatio}x<br>
        ğŸ¤– ç³»ç»Ÿï¼š${isIOS ? 'iOS' : isAndroid ? 'Android' : 'å…¶ä»–'}<br>
        ğŸ“± ç§»åŠ¨ç«¯ï¼š${isMobile ? 'æ˜¯' : 'å¦'}
      `;
    }

    // è¿è¡Œè¯Šæ–­
    function runDiagnostics() {
      const resultDiv = document.getElementById('diagnostics-result');
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      
      // åŸºæœ¬æ£€æŸ¥
      const checks = [];
      
      // 1. å±å¹•å°ºå¯¸æ£€æŸ¥
      if (screenWidth < 320) {
        checks.push({type: 'error', msg: 'å±å¹•å®½åº¦è¿‡å° (<320px)ï¼Œå¯èƒ½å¯¼è‡´æ˜¾ç¤ºé—®é¢˜'});
      } else if (screenWidth <= 640) {
        checks.push({type: 'warning', msg: `æ‰‹æœºç«¯å±å¹• (${screenWidth}px)ï¼Œä½¿ç”¨ä¼˜åŒ–ç¼©æ”¾`});
      } else {
        checks.push({type: 'success', msg: `å±å¹•å°ºå¯¸æ­£å¸¸ (${screenWidth}px)`});
      }
      
      // 2. Canvasæ”¯æŒæ£€æŸ¥
      try {
        const testCanvas = document.createElement('canvas');
        const testCtx = testCanvas.getContext('2d');
        if (testCtx) {
          checks.push({type: 'success', msg: 'Canvas 2Dæ”¯æŒæ­£å¸¸'});
        } else {
          checks.push({type: 'error', msg: 'Canvas 2Dä¸Šä¸‹æ–‡è·å–å¤±è´¥'});
        }
      } catch (e) {
        checks.push({type: 'error', msg: 'Canvasä¸æ”¯æŒ: ' + e.message});
      }
      
      // 3. ç¼©æ”¾å‚æ•°è®¡ç®—
      const margin = isMobile ? 4 : 16;
      const estimatedCanvasWidth = screenWidth * 0.9;
      const availableWidth = Math.max(100, estimatedCanvasWidth - margin * 2);
      const baseCubeWidth = 60;
      const cols = 7; // å…³å¡1å‚æ•°
      const layers = 8;
      const layerOffset = (layers - 1) * baseCubeWidth * 0.5 * Math.cos(Math.PI / 4);
      const requiredWidth = cols * baseCubeWidth + layerOffset;
      const widthScale = Math.max(0.1, availableWidth / requiredWidth);
      const minScale = isMobile ? 0.5 : 0.6;
      const finalScale = Math.max(widthScale * 0.95, minScale);
      const safeScale = Math.max(0.3, Math.min(finalScale, 2.0));
      const cubeWidth = Math.max(20, Math.floor(baseCubeWidth * safeScale));
      
      if (cubeWidth < 15) {
        checks.push({type: 'error', msg: `ç«‹æ–¹ä½“è¿‡å° (${cubeWidth}px)ï¼Œå¯èƒ½ä¸å¯è§`});
      } else if (cubeWidth < 25) {
        checks.push({type: 'warning', msg: `ç«‹æ–¹ä½“è¾ƒå° (${cubeWidth}px)ï¼Œä½“éªŒå¯èƒ½ä¸ä½³`});
      } else {
        checks.push({type: 'success', msg: `ç«‹æ–¹ä½“å¤§å°æ­£å¸¸ (${cubeWidth}px)`});
      }
      
      // 4. å†…å­˜å’Œæ€§èƒ½æ£€æŸ¥
      if (navigator.deviceMemory && navigator.deviceMemory < 2) {
        checks.push({type: 'warning', msg: 'è®¾å¤‡å†…å­˜è¾ƒä½ï¼Œå¯èƒ½å½±å“æ€§èƒ½'});
      }
      
      // ç”Ÿæˆç»“æœ
      let html = '<h4>ğŸ” è¯Šæ–­ç»“æœ</h4>';
      checks.forEach(check => {
        html += `<div class="${check.type}">${check.msg}</div>`;
      });
      
      html += `
        <div class="info">
          <h5>ğŸ“Š è®¡ç®—è¯¦æƒ…</h5>
          <pre>
å±å¹•å®½åº¦: ${screenWidth}px
ä¼°ç®—ç”»å¸ƒå®½åº¦: ${estimatedCanvasWidth}px
å¯ç”¨å®½åº¦: ${availableWidth}px
æ‰€éœ€å®½åº¦: ${Math.round(requiredWidth)}px
å®½åº¦ç¼©æ”¾: ${widthScale.toFixed(3)}
æœ€å°ç¼©æ”¾: ${minScale}
æœ€ç»ˆç¼©æ”¾: ${finalScale.toFixed(3)}
å®‰å…¨ç¼©æ”¾: ${safeScale.toFixed(3)}
ç«‹æ–¹ä½“å¤§å°: ${cubeWidth}px
          </pre>
        </div>
      `;
      
      resultDiv.innerHTML = html;
    }

    function openGame() {
      window.open('/mlg/', '_blank');
    }

    // æ•è·æ§åˆ¶å°æ—¥å¿—
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    const logs = [];

    console.log = function(...args) {
      logs.push({type: 'log', args: args, time: new Date().toLocaleTimeString()});
      originalLog.apply(console, args);
      updateConsoleLogs();
    };

    console.warn = function(...args) {
      logs.push({type: 'warn', args: args, time: new Date().toLocaleTimeString()});
      originalWarn.apply(console, args);
      updateConsoleLogs();
    };

    console.error = function(...args) {
      logs.push({type: 'error', args: args, time: new Date().toLocaleTimeString()});
      originalError.apply(console, args);
      updateConsoleLogs();
    };

    function updateConsoleLogs() {
      const logsDiv = document.getElementById('console-logs');
      const recentLogs = logs.slice(-10); // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
      
      let html = '';
      recentLogs.forEach(log => {
        const className = log.type === 'error' ? 'error' : log.type === 'warn' ? 'warning' : 'info';
        const message = log.args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');
        html += `<div class="${className}"><small>${log.time}</small> ${message}</div>`;
      });
      
      logsDiv.innerHTML = html || '<div class="info">æš‚æ— æ—¥å¿—</div>';
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      updateDeviceInfo();
      runDiagnostics();
    });

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      updateDeviceInfo();
      runDiagnostics();
    });
  </script>
</body>
</html>
