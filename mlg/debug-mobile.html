<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLG 手机端调试</title>
  <style>
    body { font-family: monospace; padding: 10px; background: #f5f5f5; margin: 0; font-size: 12px; }
    .debug-panel { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
    .error { background: #f8d7da; color: #721c24; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .success { background: #d4edda; color: #155724; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 8px; border-radius: 4px; margin: 5px 0; }
    .warning { background: #fff3cd; color: #856404; padding: 8px; border-radius: 4px; margin: 5px 0; }
    button { padding: 6px 12px; margin: 3px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
    .btn-test { background: #007acc; color: white; }
    .btn-open { background: #28a745; color: white; }
    .btn-refresh { background: #ffc107; color: black; }
    pre { background: #f8f9fa; padding: 8px; border-radius: 4px; overflow-x: auto; font-size: 10px; }
    .device-info { background: #e3f2fd; padding: 8px; border-radius: 4px; margin: 5px 0; }
    iframe { width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="debug-panel">
    <h2>📱 MLG 手机端调试面板</h2>
    <div class="device-info" id="device-info">设备信息加载中...</div>
    
    <div style="text-align: center; margin: 10px 0;">
      <button class="btn-test" onclick="runDiagnostics()">运行诊断</button>
      <button class="btn-open" onclick="openGame()">打开游戏</button>
      <button class="btn-refresh" onclick="location.reload()">刷新页面</button>
    </div>
    
    <div id="diagnostics-result"></div>
  </div>

  <div class="debug-panel">
    <h3>🎮 游戏预览</h3>
    <iframe src="/mlg/" id="game-iframe"></iframe>
    <div class="info">
      <strong>检查要点：</strong><br>
      • 是否能看到立方体<br>
      • 立方体大小是否合适<br>
      • 是否有JavaScript错误<br>
      • 控制台是否有调试信息
    </div>
  </div>

  <div class="debug-panel">
    <h3>📊 控制台日志</h3>
    <div class="warning">
      <strong>查看控制台：</strong><br>
      1. 在手机浏览器中打开开发者工具<br>
      2. 查看Console标签页<br>
      3. 寻找"动态缩放详情"日志<br>
      4. 检查是否有错误信息
    </div>
    <div id="console-logs"></div>
  </div>

  <div class="debug-panel">
    <h3>🔧 常见问题排查</h3>
    <div class="info">
      <strong>可能的问题：</strong><br>
      1. <strong>画布尺寸问题</strong>：画布宽度或高度为0<br>
      2. <strong>缩放计算错误</strong>：立方体大小计算为0或负数<br>
      3. <strong>矩形信息缺失</strong>：computeTileRects返回空值<br>
      4. <strong>渲染上下文问题</strong>：Canvas 2D上下文获取失败<br>
      5. <strong>CSS样式冲突</strong>：画布被隐藏或遮挡<br><br>
      
      <strong>解决方案：</strong><br>
      • 检查控制台调试信息<br>
      • 确认画布尺寸正常<br>
      • 验证缩放计算结果<br>
      • 检查立方体数量和位置
    </div>
  </div>

  <script>
    // 设备信息检测
    function updateDeviceInfo() {
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      const devicePixelRatio = window.devicePixelRatio || 1;
      const userAgent = navigator.userAgent;
      
      let deviceType = 'Unknown';
      if (screenWidth <= 480) {
        deviceType = '超小屏手机';
      } else if (screenWidth <= 640) {
        deviceType = '小屏手机';
      } else if (screenWidth <= 768) {
        deviceType = '大屏手机/平板竖屏';
      } else {
        deviceType = 'PC端/平板横屏';
      }
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
      const isAndroid = /Android/i.test(userAgent);
      
      document.getElementById('device-info').innerHTML = `
        <strong>设备信息：</strong><br>
        📱 类型：${deviceType}<br>
        📏 屏幕：${screenWidth} × ${screenHeight}px<br>
        🔍 像素比：${devicePixelRatio}x<br>
        🤖 系统：${isIOS ? 'iOS' : isAndroid ? 'Android' : '其他'}<br>
        📱 移动端：${isMobile ? '是' : '否'}
      `;
    }

    // 运行诊断
    function runDiagnostics() {
      const resultDiv = document.getElementById('diagnostics-result');
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      
      // 基本检查
      const checks = [];
      
      // 1. 屏幕尺寸检查
      if (screenWidth < 320) {
        checks.push({type: 'error', msg: '屏幕宽度过小 (<320px)，可能导致显示问题'});
      } else if (screenWidth <= 640) {
        checks.push({type: 'warning', msg: `手机端屏幕 (${screenWidth}px)，使用优化缩放`});
      } else {
        checks.push({type: 'success', msg: `屏幕尺寸正常 (${screenWidth}px)`});
      }
      
      // 2. Canvas支持检查
      try {
        const testCanvas = document.createElement('canvas');
        const testCtx = testCanvas.getContext('2d');
        if (testCtx) {
          checks.push({type: 'success', msg: 'Canvas 2D支持正常'});
        } else {
          checks.push({type: 'error', msg: 'Canvas 2D上下文获取失败'});
        }
      } catch (e) {
        checks.push({type: 'error', msg: 'Canvas不支持: ' + e.message});
      }
      
      // 3. 缩放参数计算
      const margin = isMobile ? 4 : 16;
      const estimatedCanvasWidth = screenWidth * 0.9;
      const availableWidth = Math.max(100, estimatedCanvasWidth - margin * 2);
      const baseCubeWidth = 60;
      const cols = 7; // 关卡1参数
      const layers = 8;
      const layerOffset = (layers - 1) * baseCubeWidth * 0.5 * Math.cos(Math.PI / 4);
      const requiredWidth = cols * baseCubeWidth + layerOffset;
      const widthScale = Math.max(0.1, availableWidth / requiredWidth);
      const minScale = isMobile ? 0.5 : 0.6;
      const finalScale = Math.max(widthScale * 0.95, minScale);
      const safeScale = Math.max(0.3, Math.min(finalScale, 2.0));
      const cubeWidth = Math.max(20, Math.floor(baseCubeWidth * safeScale));
      
      if (cubeWidth < 15) {
        checks.push({type: 'error', msg: `立方体过小 (${cubeWidth}px)，可能不可见`});
      } else if (cubeWidth < 25) {
        checks.push({type: 'warning', msg: `立方体较小 (${cubeWidth}px)，体验可能不佳`});
      } else {
        checks.push({type: 'success', msg: `立方体大小正常 (${cubeWidth}px)`});
      }
      
      // 4. 内存和性能检查
      if (navigator.deviceMemory && navigator.deviceMemory < 2) {
        checks.push({type: 'warning', msg: '设备内存较低，可能影响性能'});
      }
      
      // 生成结果
      let html = '<h4>🔍 诊断结果</h4>';
      checks.forEach(check => {
        html += `<div class="${check.type}">${check.msg}</div>`;
      });
      
      html += `
        <div class="info">
          <h5>📊 计算详情</h5>
          <pre>
屏幕宽度: ${screenWidth}px
估算画布宽度: ${estimatedCanvasWidth}px
可用宽度: ${availableWidth}px
所需宽度: ${Math.round(requiredWidth)}px
宽度缩放: ${widthScale.toFixed(3)}
最小缩放: ${minScale}
最终缩放: ${finalScale.toFixed(3)}
安全缩放: ${safeScale.toFixed(3)}
立方体大小: ${cubeWidth}px
          </pre>
        </div>
      `;
      
      resultDiv.innerHTML = html;
    }

    function openGame() {
      window.open('/mlg/', '_blank');
    }

    // 捕获控制台日志
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    const logs = [];

    console.log = function(...args) {
      logs.push({type: 'log', args: args, time: new Date().toLocaleTimeString()});
      originalLog.apply(console, args);
      updateConsoleLogs();
    };

    console.warn = function(...args) {
      logs.push({type: 'warn', args: args, time: new Date().toLocaleTimeString()});
      originalWarn.apply(console, args);
      updateConsoleLogs();
    };

    console.error = function(...args) {
      logs.push({type: 'error', args: args, time: new Date().toLocaleTimeString()});
      originalError.apply(console, args);
      updateConsoleLogs();
    };

    function updateConsoleLogs() {
      const logsDiv = document.getElementById('console-logs');
      const recentLogs = logs.slice(-10); // 只显示最近10条
      
      let html = '';
      recentLogs.forEach(log => {
        const className = log.type === 'error' ? 'error' : log.type === 'warn' ? 'warning' : 'info';
        const message = log.args.map(arg => 
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');
        html += `<div class="${className}"><small>${log.time}</small> ${message}</div>`;
      });
      
      logsDiv.innerHTML = html || '<div class="info">暂无日志</div>';
    }

    // 初始化
    window.addEventListener('load', () => {
      updateDeviceInfo();
      runDiagnostics();
    });

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
      updateDeviceInfo();
      runDiagnostics();
    });
  </script>
</body>
</html>
