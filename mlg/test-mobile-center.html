<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MLG æ‰‹æœºç«¯å±…ä¸­æµ‹è¯•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/theme.css" />
</head>
<body class="min-h-screen">
  <main class="mx-auto max-w-5xl px-4 py-6" style="color: var(--text-color-primary)">
    <h1 class="text-xl font-bold mb-2 text-white">æ‰‹æœºç«¯å±…ä¸­æµ‹è¯•</h1>
    <p class="mb-4 text-xs text-gray-300">éªŒè¯ç«‹æ–¹ä½“åœ¨æ‰‹æœºä¸Šæ˜¯å¦æ­£ç¡®å±…ä¸­æ˜¾ç¤º</p>
    
    <div class="bg-slate-800 p-3 rounded-lg mb-4">
      <h3 class="text-sm font-semibold mb-2 text-white">å½“å‰çŠ¶æ€</h3>
      <div class="text-xs text-gray-300 space-y-1">
        <div>å±å¹•: <span id="screen-info"></span></div>
        <div>ç”»å¸ƒ: <span id="canvas-info"></span></div>
        <div>ç½‘æ ¼: <span id="grid-info"></span></div>
        <div>å±…ä¸­: <span id="center-info"></span></div>
      </div>
    </div>
    
    <div id="game-container" class="game-container mlg-card" style="background: var(--card-bg);">
      <canvas id="test-canvas" class="game-canvas" style="height: 300px;"></canvas>
    </div>
    
    <div class="mt-4 text-xs text-gray-300 bg-slate-800 p-3 rounded-lg">
      <p class="font-semibold mb-1">å±…ä¸­ç­–ç•¥ï¼š</p>
      <ul class="list-disc list-inside space-y-1">
        <li>å†…å®¹é€‚åˆç”»å¸ƒï¼šå®Œå…¨å±…ä¸­</li>
        <li>å†…å®¹è¶…å‡ºç”»å¸ƒï¼šä¼˜å…ˆæ˜¾ç¤ºç½‘æ ¼ä¸­å¿ƒ</li>
        <li>ä¿æŒæœ€å°è¾¹è·ï¼š10px</li>
        <li>è€ƒè™‘å±‚çº§åç§»ï¼š45åº¦è§’åç§»</li>
      </ul>
    </div>
  </main>

  <script src="js/game.js"></script>
  <script>
    const canvas = document.getElementById('test-canvas');
    const ctx = canvas.getContext('2d');
    
    function calculateLayout() {
      const screenWidth = window.innerWidth;
      const baseCubeWidth = 60;
      
      // å±å¹•ç¼©æ”¾
      let screenScale = 1;
      if (screenWidth <= 480) {
        screenScale = 0.6;
      } else if (screenWidth <= 640) {
        screenScale = 0.7;
      } else if (screenWidth <= 768) {
        screenScale = 0.85;
      }
      
      const cubeWidth = Math.floor(baseCubeWidth * screenScale);
      const cubeHeight = Math.floor(cubeWidth * 2.2 / 2);
      
      // æ¨¡æ‹Ÿæ¸¸æˆç½‘æ ¼ï¼ˆæ‰‹æœºä¸Šé€šå¸¸æ˜¯è¾ƒå¤§çš„ç½‘æ ¼ï¼‰
      const cols = screenWidth <= 480 ? 8 : 7;
      const rows = screenWidth <= 480 ? 10 : 9;
      const layers = 4;
      
      const baseGridWidth = cols * cubeWidth;
      const baseGridHeight = rows * cubeHeight;
      
      // å±‚çº§åç§»
      const maxLayerOffset = (layers - 1) * cubeWidth * 0.5 * Math.cos(Math.PI / 4);
      const totalWidth = baseGridWidth + maxLayerOffset;
      const totalHeight = baseGridHeight + maxLayerOffset;
      
      return {
        screenWidth,
        screenScale,
        cubeWidth,
        cubeHeight,
        cols,
        rows,
        layers,
        baseGridWidth,
        baseGridHeight,
        totalWidth,
        totalHeight,
        maxLayerOffset
      };
    }
    
    function calculateCenter(layout, canvasWidth, canvasHeight) {
      let startX, startY;
      
      if (layout.totalWidth <= canvasWidth) {
        startX = Math.floor((canvasWidth - layout.totalWidth) / 2);
      } else {
        const availableWidth = canvasWidth - 20;
        const gridCenterOffset = Math.floor((availableWidth - layout.baseGridWidth) / 2);
        startX = Math.max(10, gridCenterOffset);
      }
      
      if (layout.totalHeight <= canvasHeight) {
        startY = Math.floor((canvasHeight - layout.totalHeight) / 2);
      } else {
        const availableHeight = canvasHeight - 20;
        const gridCenterOffset = Math.floor((availableHeight - layout.baseGridHeight) / 2);
        startY = Math.max(10, gridCenterOffset);
      }
      
      return { startX, startY };
    }
    
    function updateInfo() {
      const layout = calculateLayout();
      const rect = canvas.getBoundingClientRect();
      const center = calculateCenter(layout, rect.width, rect.height);
      
      document.getElementById('screen-info').textContent = 
        `${layout.screenWidth}px (${(layout.screenScale * 100).toFixed(0)}%)`;
      document.getElementById('canvas-info').textContent = 
        `${Math.floor(rect.width)}Ã—${Math.floor(rect.height)}px`;
      document.getElementById('grid-info').textContent = 
        `${layout.cols}Ã—${layout.rows} (${layout.cubeWidth}Ã—${layout.cubeHeight}px)`;
      document.getElementById('center-info').textContent = 
        `èµ·ç‚¹(${center.startX}, ${center.startY})`;
    }
    
    function renderTest() {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      // èƒŒæ™¯
      ctx.fillStyle = '#1E293B';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const layout = calculateLayout();
      const center = calculateCenter(layout, canvas.width, canvas.height);
      
      // ç»˜åˆ¶ç½‘æ ¼è¾¹ç•Œï¼ˆè°ƒè¯•ç”¨ï¼‰
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
      ctx.lineWidth = 1;
      ctx.strokeRect(center.startX, center.startY, layout.baseGridWidth, layout.baseGridHeight);
      
      // ç»˜åˆ¶æ€»è¾¹ç•Œï¼ˆåŒ…å«å±‚çº§åç§»ï¼‰
      ctx.strokeStyle = 'rgba(255, 255, 0, 0.3)';
      ctx.strokeRect(center.startX, center.startY, layout.totalWidth, layout.totalHeight);
      
      // ç»˜åˆ¶ä¸€äº›ç¤ºä¾‹ç«‹æ–¹ä½“
      const testPositions = [
        { col: 0, row: 0, layer: 0 },
        { col: 1, row: 0, layer: 1 },
        { col: 2, row: 0, layer: 2 },
        { col: 0, row: 1, layer: 0 },
        { col: 1, row: 1, layer: 1 },
        { col: layout.cols - 1, row: 0, layer: 0 },
        { col: layout.cols - 1, row: layout.rows - 1, layer: 0 },
        { col: 0, row: layout.rows - 1, layer: 0 },
      ];
      
      const symbols = ['ğŸŒŸ', 'ğŸ¯', 'ğŸ²', 'ğŸ”®', 'ğŸ’', 'â­', 'ğŸ†', 'ğŸ'];
      
      testPositions.forEach((pos, index) => {
        if (pos.col >= layout.cols || pos.row >= layout.rows) return;
        
        const baseX = center.startX + pos.col * layout.cubeWidth;
        const baseY = center.startY + pos.row * layout.cubeHeight;
        
        // 45åº¦è§’åç§»
        const halfGrid = layout.cubeWidth * 0.5;
        const angle45 = Math.PI / 4;
        const layerOffsetX = pos.layer * halfGrid * Math.cos(angle45);
        const layerOffsetY = pos.layer * halfGrid * Math.sin(angle45);
        
        const x = baseX + layerOffsetX;
        const y = baseY + layerOffsetY;
        
        // ç»˜åˆ¶ç«‹æ–¹ä½“
        if (window.MLG && window.MLG.drawCuboid) {
          const depth = 12;
          window.MLG.drawCuboid(ctx, x, y, layout.cubeWidth, layout.cubeHeight, depth, {
            actualLayer: pos.layer,
            isTopAtPosition: true,
            relativeDepth: 0
          });
          
          // ç»˜åˆ¶ç¬¦å·
          const fontSize = Math.floor(Math.min(layout.cubeWidth, layout.cubeHeight) * 0.6);
          ctx.font = `${fontSize}px system-ui`;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillStyle = 'rgba(31, 41, 55, 1)';
          ctx.fillText(symbols[index], x + layout.cubeWidth / 2, y + layout.cubeHeight / 2);
        }
      });
      
      // ç»˜åˆ¶ä¸­å¿ƒçº¿ï¼ˆè°ƒè¯•ç”¨ï¼‰
      ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.moveTo(0, canvas.height / 2);
      ctx.lineTo(canvas.width, canvas.height / 2);
      ctx.stroke();
      
      // æ ‡é¢˜
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.font = '14px system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText('æ‰‹æœºç«¯å±…ä¸­æµ‹è¯•', canvas.width / 2, 10);
      
      ctx.font = '10px system-ui';
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.fillText(`ç½‘æ ¼: ${layout.cols}Ã—${layout.rows}, ç«‹æ–¹ä½“: ${layout.cubeWidth}Ã—${layout.cubeHeight}px`, canvas.width / 2, 30);
    }
    
    // åˆå§‹åŒ–
    updateInfo();
    renderTest();
    
    // ç›‘å¬å˜åŒ–
    window.addEventListener('resize', () => {
      updateInfo();
      renderTest();
    });
  </script>
</body>
</html>
