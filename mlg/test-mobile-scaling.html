<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLG æ‰‹æœºç«¯ç¼©æ”¾æµ‹è¯•</title>
  <style>
    body { font-family: monospace; padding: 10px; background: #f5f5f5; margin: 0; }
    .test-header { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .device-info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .test-case { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #007acc; }
    .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-size: 12px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
    button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-test { background: #007acc; color: white; }
    .btn-open { background: #28a745; color: white; }
    .btn-debug { background: #ffc107; color: black; }
    .device-frame { border: 2px solid #ccc; border-radius: 12px; margin: 10px 0; overflow: hidden; }
    .device-screen { background: #000; padding: 10px; }
    iframe { width: 100%; height: 400px; border: none; }
    .scale-info { background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 11px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .test-header h1 { font-size: 18px; margin: 0; }
      .test-case h3 { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="test-header">
    <h1>ğŸ“± MLG æ‰‹æœºç«¯ç¼©æ”¾æµ‹è¯•</h1>
    <div class="device-info" id="device-info">
      <strong>è®¾å¤‡ä¿¡æ¯åŠ è½½ä¸­...</strong>
    </div>
  </div>

  <div class="test-case">
    <h3>ğŸ”§ åŠ¨æ€ç¼©æ”¾ç®—æ³•ä¿®å¤</h3>
    <div class="result info">
      <strong>ä¿®å¤å†…å®¹ï¼š</strong><br>
      âœ… ä»å›ºå®šå±å¹•å®½åº¦ç¼©æ”¾æ”¹ä¸ºåŠ¨æ€ç”»å¸ƒé€‚åº”ç¼©æ”¾<br>
      âœ… æ ¹æ®å®é™…å¯ç”¨ç©ºé—´å’Œå†…å®¹éœ€æ±‚è®¡ç®—ç¼©æ”¾æ¯”ä¾‹<br>
      âœ… ç¡®ä¿å†…å®¹æ€»æ˜¯èƒ½å®Œå…¨æ”¾åœ¨ç”»å¸ƒå†…<br>
      âœ… æ·»åŠ æœ€å°ç¼©æ”¾é™åˆ¶ï¼Œé˜²æ­¢ç«‹æ–¹ä½“è¿‡å°
    </div>
    
    <div class="scale-info" id="scale-info">
      ç¼©æ”¾ä¿¡æ¯åŠ è½½ä¸­...
    </div>
    
    <button class="btn-test" onclick="testScaling()">æµ‹è¯•ç¼©æ”¾ç®—æ³•</button>
    <button class="btn-debug" onclick="openWithDebug()">è°ƒè¯•æ¨¡å¼</button>
    <button class="btn-open" onclick="openGame()">æ‰“å¼€æ¸¸æˆ</button>
    
    <div id="scaling-result"></div>
  </div>

  <div class="grid">
    <div class="test-case">
      <h3>ğŸ“ ç¼©æ”¾å‰åå¯¹æ¯”</h3>
      <div class="result warning">
        <strong>ä¿®å¤å‰é—®é¢˜ï¼š</strong><br>
        â€¢ å›ºå®šç¼©æ”¾æ¯”ä¾‹ï¼š640pxä»¥ä¸‹ = 0.7å€<br>
        â€¢ ä¸è€ƒè™‘ç”»å¸ƒå®é™…å®½åº¦<br>
        â€¢ ä¸è€ƒè™‘ç½‘æ ¼åˆ—æ•°å’Œå±‚çº§<br>
        â€¢ å¯¼è‡´å†…å®¹è¶…å‡ºç”»å¸ƒè¾¹ç•Œ
      </div>
      <div class="result success">
        <strong>ä¿®å¤åæ”¹è¿›ï¼š</strong><br>
        â€¢ åŠ¨æ€è®¡ç®—æ‰€éœ€ç©ºé—´<br>
        â€¢ æ ¹æ®ç”»å¸ƒå¯ç”¨å®½åº¦è°ƒæ•´<br>
        â€¢ ç¡®ä¿å†…å®¹å®Œå…¨å¯è§<br>
        â€¢ ä¿æŒæœ€å°å¯ç”¨æ€§
      </div>
    </div>

    <div class="test-case">
      <h3>ğŸ¯ æµ‹è¯•åœºæ™¯</h3>
      <div class="result info">
        <strong>å…³é”®æµ‹è¯•ç‚¹ï¼š</strong><br>
        1. å³ä¾§ç«‹æ–¹ä½“æ˜¯å¦å®Œæ•´æ˜¾ç¤º<br>
        2. ç«‹æ–¹ä½“å¤§å°æ˜¯å¦åˆé€‚<br>
        3. å†…å®¹æ˜¯å¦æ­£ç¡®å±…ä¸­<br>
        4. ä¸åŒå…³å¡çš„é€‚åº”æ€§<br><br>
        
        <strong>æµ‹è¯•è®¾å¤‡ï¼š</strong><br>
        ğŸ“± iPhone SE (375px)<br>
        ğŸ“± iPhone 12 (390px)<br>
        ğŸ“± iPhone 12 Pro Max (428px)<br>
        ğŸ“± Android å°å± (360px)<br>
        ğŸ“± Android å¤§å± (414px)
      </div>
    </div>
  </div>

  <div class="test-case">
    <h3>ğŸ–¼ï¸ å®æ—¶é¢„è§ˆ</h3>
    <div class="device-frame">
      <div class="device-screen">
        <iframe src="/mlg/" id="game-preview"></iframe>
      </div>
    </div>
    <div class="result info">
      <strong>æ£€æŸ¥è¦ç‚¹ï¼š</strong><br>
      âœ… å³ä¾§ç«‹æ–¹ä½“æ˜¯å¦è¢«æˆªæ–­<br>
      âœ… ç«‹æ–¹ä½“å¤§å°æ˜¯å¦åˆé€‚<br>
      âœ… æ•´ä½“å¸ƒå±€æ˜¯å¦å±…ä¸­<br>
      âœ… è§¦æ‘¸æ“ä½œæ˜¯å¦æ­£å¸¸
    </div>
  </div>

  <div class="test-case">
    <h3>ğŸ“Š ç¼©æ”¾ç®—æ³•è¯¦æƒ…</h3>
    <div class="result info">
      <strong>æ–°ç®—æ³•æµç¨‹ï¼š</strong><br>
      1. <code>availableWidth = cssWidth - margin * 2</code><br>
      2. <code>requiredWidth = cols * baseCubeWidth + layerOffset</code><br>
      3. <code>dynamicScale = min(availableWidth/requiredWidth, 1)</code><br>
      4. <code>finalScale = max(dynamicScale, minScale)</code><br>
      5. <code>cubeWidth = baseCubeWidth * finalScale</code><br><br>
      
      <strong>å…³é”®å‚æ•°ï¼š</strong><br>
      â€¢ åŸºç¡€ç«‹æ–¹ä½“å®½åº¦ï¼š60px<br>
      â€¢ æ‰‹æœºç«¯æœ€å°ç¼©æ”¾ï¼š0.4<br>
      â€¢ PCç«¯æœ€å°ç¼©æ”¾ï¼š0.6<br>
      â€¢ æ‰‹æœºç«¯è¾¹è·ï¼š6px<br>
      â€¢ PCç«¯è¾¹è·ï¼š16px
    </div>
  </div>

  <script>
    // è®¾å¤‡ä¿¡æ¯æ£€æµ‹
    function updateDeviceInfo() {
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      const devicePixelRatio = window.devicePixelRatio || 1;
      const userAgent = navigator.userAgent;
      
      let deviceType = 'Unknown';
      let deviceName = 'Unknown Device';
      
      if (screenWidth <= 480) {
        deviceType = 'è¶…å°å±æ‰‹æœº';
        deviceName = 'iPhone SEç±»å‹';
      } else if (screenWidth <= 640) {
        deviceType = 'å°å±æ‰‹æœº';
        deviceName = 'iPhone 12ç±»å‹';
      } else if (screenWidth <= 768) {
        deviceType = 'å¤§å±æ‰‹æœº/å¹³æ¿ç«–å±';
        deviceName = 'iPhone Pro Max/iPadç«–å±';
      } else if (screenWidth <= 1024) {
        deviceType = 'å¹³æ¿æ¨ªå±';
        deviceName = 'iPadæ¨ªå±';
      } else {
        deviceType = 'PCç«¯';
        deviceName = 'æ¡Œé¢æµè§ˆå™¨';
      }
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
      const isAndroid = /Android/i.test(userAgent);
      
      document.getElementById('device-info').innerHTML = `
        <strong>è®¾å¤‡ä¿¡æ¯ï¼š</strong><br>
        ğŸ“± è®¾å¤‡ç±»å‹ï¼š${deviceType} (${deviceName})<br>
        ğŸ“ å±å¹•å°ºå¯¸ï¼š${screenWidth} Ã— ${screenHeight}px<br>
        ğŸ” åƒç´ æ¯”ï¼š${devicePixelRatio}x<br>
        ğŸ¤– ç³»ç»Ÿï¼š${isIOS ? 'iOS' : isAndroid ? 'Android' : 'å…¶ä»–'}<br>
        ğŸ“± ç§»åŠ¨ç«¯ï¼š${isMobile ? 'æ˜¯' : 'å¦'}
      `;
    }

    // ç¼©æ”¾ä¿¡æ¯è®¡ç®—
    function updateScaleInfo() {
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      const margin = isMobile ? 6 : 16;
      const baseCubeWidth = 60;
      
      // æ¨¡æ‹Ÿç”»å¸ƒå®½åº¦ï¼ˆå‡è®¾ä¸ºå±å¹•å®½åº¦çš„90%ï¼‰
      const estimatedCanvasWidth = screenWidth * 0.9;
      const availableWidth = estimatedCanvasWidth - margin * 2;
      
      // æ¨¡æ‹Ÿç½‘æ ¼å‚æ•°ï¼ˆå…³å¡1çš„å‚æ•°ï¼‰
      const cols = 7;
      const layers = 8;
      const layerOffset = (layers - 1) * baseCubeWidth * 0.5 * Math.cos(Math.PI / 4);
      const requiredWidth = cols * baseCubeWidth + layerOffset;
      
      const widthScale = availableWidth / requiredWidth;
      const dynamicScale = Math.min(widthScale, 1);
      const minScale = isMobile ? 0.4 : 0.6;
      const finalScale = Math.max(dynamicScale, minScale);
      const finalCubeWidth = Math.floor(baseCubeWidth * finalScale);
      
      document.getElementById('scale-info').innerHTML = `
        <strong>ç¼©æ”¾è®¡ç®—ï¼ˆå…³å¡1ä¼°ç®—ï¼‰ï¼š</strong><br>
        ç”»å¸ƒå¯ç”¨å®½åº¦ï¼š${Math.round(availableWidth)}px<br>
        æ‰€éœ€æœ€å°å®½åº¦ï¼š${Math.round(requiredWidth)}px<br>
        å®½åº¦ç¼©æ”¾æ¯”ï¼š${widthScale.toFixed(3)}<br>
        åŠ¨æ€ç¼©æ”¾æ¯”ï¼š${dynamicScale.toFixed(3)}<br>
        æœ€ç»ˆç¼©æ”¾æ¯”ï¼š${finalScale.toFixed(3)}<br>
        ç«‹æ–¹ä½“å°ºå¯¸ï¼š${finalCubeWidth}px (åŸå§‹60px)
      `;
    }

    function testScaling() {
      const resultDiv = document.getElementById('scaling-result');
      const screenWidth = window.innerWidth;
      
      resultDiv.innerHTML = `
        <div class="result ${screenWidth <= 640 ? 'success' : 'info'}">
          <h4>ç¼©æ”¾æµ‹è¯•ç»“æœ</h4>
          <p><strong>å½“å‰å±å¹•ï¼š</strong> ${screenWidth}px</p>
          <p><strong>ä¿®å¤çŠ¶æ€ï¼š</strong> âœ… åŠ¨æ€ç¼©æ”¾ç®—æ³•å·²åº”ç”¨</p>
          <p><strong>é¢„æœŸæ•ˆæœï¼š</strong></p>
          <ul>
            <li>âœ… ç«‹æ–¹ä½“å¤§å°æ ¹æ®å¯ç”¨ç©ºé—´åŠ¨æ€è°ƒæ•´</li>
            <li>âœ… å³ä¾§ç«‹æ–¹ä½“ä¸ä¼šè¢«æˆªæ–­</li>
            <li>âœ… å†…å®¹å®Œå…¨é€‚åº”ç”»å¸ƒå¤§å°</li>
            <li>âœ… ä¿æŒæœ€å°å¯ç”¨æ€§</li>
          </ul>
          ${screenWidth <= 640 ? 
            '<p class="success">âœ… å½“å‰ä¸ºæ‰‹æœºç«¯ï¼Œå¯ç›´æ¥éªŒè¯ä¿®å¤æ•ˆæœ</p>' : 
            '<p class="info">ğŸ’¡ è¯·åœ¨æ‰‹æœºç«¯æˆ–è°ƒæ•´æµè§ˆå™¨çª—å£éªŒè¯</p>'
          }
        </div>
      `;
    }

    function openGame() {
      window.open('/mlg/', '_blank');
    }

    function openWithDebug() {
      window.open('/mlg/?debug=scale', '_blank');
    }

    // åˆå§‹åŒ–
    window.addEventListener('load', () => {
      updateDeviceInfo();
      updateScaleInfo();
    });

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', () => {
      updateDeviceInfo();
      updateScaleInfo();
      
      // åˆ·æ–°é¢„è§ˆ
      const preview = document.getElementById('game-preview');
      if (preview) {
        preview.src = preview.src;
      }
    });

    // å®šæœŸæ›´æ–°é¢„è§ˆ
    setInterval(() => {
      const preview = document.getElementById('game-preview');
      if (preview && document.visibilityState === 'visible') {
        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡é¢„è§ˆ
        preview.src = preview.src;
      }
    }, 30000);
  </script>
</body>
</html>
