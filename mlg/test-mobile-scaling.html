<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MLG 手机端缩放测试</title>
  <style>
    body { font-family: monospace; padding: 10px; background: #f5f5f5; margin: 0; }
    .test-header { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    .device-info { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; }
    .test-case { background: white; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid #007acc; }
    .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-size: 12px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
    button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn-test { background: #007acc; color: white; }
    .btn-open { background: #28a745; color: white; }
    .btn-debug { background: #ffc107; color: black; }
    .device-frame { border: 2px solid #ccc; border-radius: 12px; margin: 10px 0; overflow: hidden; }
    .device-screen { background: #000; padding: 10px; }
    iframe { width: 100%; height: 400px; border: none; }
    .scale-info { background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 5px 0; font-size: 11px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .test-header h1 { font-size: 18px; margin: 0; }
      .test-case h3 { font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="test-header">
    <h1>📱 MLG 手机端缩放测试</h1>
    <div class="device-info" id="device-info">
      <strong>设备信息加载中...</strong>
    </div>
  </div>

  <div class="test-case">
    <h3>🔧 动态缩放算法修复</h3>
    <div class="result info">
      <strong>修复内容：</strong><br>
      ✅ 从固定屏幕宽度缩放改为动态画布适应缩放<br>
      ✅ 根据实际可用空间和内容需求计算缩放比例<br>
      ✅ 确保内容总是能完全放在画布内<br>
      ✅ 添加最小缩放限制，防止立方体过小
    </div>
    
    <div class="scale-info" id="scale-info">
      缩放信息加载中...
    </div>
    
    <button class="btn-test" onclick="testScaling()">测试缩放算法</button>
    <button class="btn-debug" onclick="openWithDebug()">调试模式</button>
    <button class="btn-open" onclick="openGame()">打开游戏</button>
    
    <div id="scaling-result"></div>
  </div>

  <div class="grid">
    <div class="test-case">
      <h3>📏 缩放前后对比</h3>
      <div class="result warning">
        <strong>修复前问题：</strong><br>
        • 固定缩放比例：640px以下 = 0.7倍<br>
        • 不考虑画布实际宽度<br>
        • 不考虑网格列数和层级<br>
        • 导致内容超出画布边界
      </div>
      <div class="result success">
        <strong>修复后改进：</strong><br>
        • 动态计算所需空间<br>
        • 根据画布可用宽度调整<br>
        • 确保内容完全可见<br>
        • 保持最小可用性
      </div>
    </div>

    <div class="test-case">
      <h3>🎯 测试场景</h3>
      <div class="result info">
        <strong>关键测试点：</strong><br>
        1. 右侧立方体是否完整显示<br>
        2. 立方体大小是否合适<br>
        3. 内容是否正确居中<br>
        4. 不同关卡的适应性<br><br>
        
        <strong>测试设备：</strong><br>
        📱 iPhone SE (375px)<br>
        📱 iPhone 12 (390px)<br>
        📱 iPhone 12 Pro Max (428px)<br>
        📱 Android 小屏 (360px)<br>
        📱 Android 大屏 (414px)
      </div>
    </div>
  </div>

  <div class="test-case">
    <h3>🖼️ 实时预览</h3>
    <div class="device-frame">
      <div class="device-screen">
        <iframe src="/mlg/" id="game-preview"></iframe>
      </div>
    </div>
    <div class="result info">
      <strong>检查要点：</strong><br>
      ✅ 右侧立方体是否被截断<br>
      ✅ 立方体大小是否合适<br>
      ✅ 整体布局是否居中<br>
      ✅ 触摸操作是否正常
    </div>
  </div>

  <div class="test-case">
    <h3>📊 缩放算法详情</h3>
    <div class="result info">
      <strong>新算法流程：</strong><br>
      1. <code>availableWidth = cssWidth - margin * 2</code><br>
      2. <code>requiredWidth = cols * baseCubeWidth + layerOffset</code><br>
      3. <code>dynamicScale = min(availableWidth/requiredWidth, 1)</code><br>
      4. <code>finalScale = max(dynamicScale, minScale)</code><br>
      5. <code>cubeWidth = baseCubeWidth * finalScale</code><br><br>
      
      <strong>关键参数：</strong><br>
      • 基础立方体宽度：60px<br>
      • 手机端最小缩放：0.4<br>
      • PC端最小缩放：0.6<br>
      • 手机端边距：6px<br>
      • PC端边距：16px
    </div>
  </div>

  <script>
    // 设备信息检测
    function updateDeviceInfo() {
      const screenWidth = window.innerWidth;
      const screenHeight = window.innerHeight;
      const devicePixelRatio = window.devicePixelRatio || 1;
      const userAgent = navigator.userAgent;
      
      let deviceType = 'Unknown';
      let deviceName = 'Unknown Device';
      
      if (screenWidth <= 480) {
        deviceType = '超小屏手机';
        deviceName = 'iPhone SE类型';
      } else if (screenWidth <= 640) {
        deviceType = '小屏手机';
        deviceName = 'iPhone 12类型';
      } else if (screenWidth <= 768) {
        deviceType = '大屏手机/平板竖屏';
        deviceName = 'iPhone Pro Max/iPad竖屏';
      } else if (screenWidth <= 1024) {
        deviceType = '平板横屏';
        deviceName = 'iPad横屏';
      } else {
        deviceType = 'PC端';
        deviceName = '桌面浏览器';
      }
      
      const isMobile = /iPhone|iPad|iPod|Android/i.test(userAgent);
      const isIOS = /iPhone|iPad|iPod/i.test(userAgent);
      const isAndroid = /Android/i.test(userAgent);
      
      document.getElementById('device-info').innerHTML = `
        <strong>设备信息：</strong><br>
        📱 设备类型：${deviceType} (${deviceName})<br>
        📏 屏幕尺寸：${screenWidth} × ${screenHeight}px<br>
        🔍 像素比：${devicePixelRatio}x<br>
        🤖 系统：${isIOS ? 'iOS' : isAndroid ? 'Android' : '其他'}<br>
        📱 移动端：${isMobile ? '是' : '否'}
      `;
    }

    // 缩放信息计算
    function updateScaleInfo() {
      const screenWidth = window.innerWidth;
      const isMobile = screenWidth <= 768;
      const margin = isMobile ? 6 : 16;
      const baseCubeWidth = 60;
      
      // 模拟画布宽度（假设为屏幕宽度的90%）
      const estimatedCanvasWidth = screenWidth * 0.9;
      const availableWidth = estimatedCanvasWidth - margin * 2;
      
      // 模拟网格参数（关卡1的参数）
      const cols = 7;
      const layers = 8;
      const layerOffset = (layers - 1) * baseCubeWidth * 0.5 * Math.cos(Math.PI / 4);
      const requiredWidth = cols * baseCubeWidth + layerOffset;
      
      const widthScale = availableWidth / requiredWidth;
      const dynamicScale = Math.min(widthScale, 1);
      const minScale = isMobile ? 0.4 : 0.6;
      const finalScale = Math.max(dynamicScale, minScale);
      const finalCubeWidth = Math.floor(baseCubeWidth * finalScale);
      
      document.getElementById('scale-info').innerHTML = `
        <strong>缩放计算（关卡1估算）：</strong><br>
        画布可用宽度：${Math.round(availableWidth)}px<br>
        所需最小宽度：${Math.round(requiredWidth)}px<br>
        宽度缩放比：${widthScale.toFixed(3)}<br>
        动态缩放比：${dynamicScale.toFixed(3)}<br>
        最终缩放比：${finalScale.toFixed(3)}<br>
        立方体尺寸：${finalCubeWidth}px (原始60px)
      `;
    }

    function testScaling() {
      const resultDiv = document.getElementById('scaling-result');
      const screenWidth = window.innerWidth;
      
      resultDiv.innerHTML = `
        <div class="result ${screenWidth <= 640 ? 'success' : 'info'}">
          <h4>缩放测试结果</h4>
          <p><strong>当前屏幕：</strong> ${screenWidth}px</p>
          <p><strong>修复状态：</strong> ✅ 动态缩放算法已应用</p>
          <p><strong>预期效果：</strong></p>
          <ul>
            <li>✅ 立方体大小根据可用空间动态调整</li>
            <li>✅ 右侧立方体不会被截断</li>
            <li>✅ 内容完全适应画布大小</li>
            <li>✅ 保持最小可用性</li>
          </ul>
          ${screenWidth <= 640 ? 
            '<p class="success">✅ 当前为手机端，可直接验证修复效果</p>' : 
            '<p class="info">💡 请在手机端或调整浏览器窗口验证</p>'
          }
        </div>
      `;
    }

    function openGame() {
      window.open('/mlg/', '_blank');
    }

    function openWithDebug() {
      window.open('/mlg/?debug=scale', '_blank');
    }

    // 初始化
    window.addEventListener('load', () => {
      updateDeviceInfo();
      updateScaleInfo();
    });

    // 监听窗口大小变化
    window.addEventListener('resize', () => {
      updateDeviceInfo();
      updateScaleInfo();
      
      // 刷新预览
      const preview = document.getElementById('game-preview');
      if (preview) {
        preview.src = preview.src;
      }
    });

    // 定期更新预览
    setInterval(() => {
      const preview = document.getElementById('game-preview');
      if (preview && document.visibilityState === 'visible') {
        // 每30秒刷新一次预览
        preview.src = preview.src;
      }
    }, 30000);
  </script>
</body>
</html>
