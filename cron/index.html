<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>在线Webhook定时任务工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=design_services" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/weekday.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/utc.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/timezone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/locale/zh-cn.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="/js/user-storage.js"></script>
    <!-- Enhanced Cron Components -->
    <script src="/cron/sync-manager.js"></script>
    <script src="/cron/enhanced-cron.js"></script>
    <script src="/cron/test-suite.js"></script>
    <!-- Unified Firebase config injected by Worker -->
    <script src="/firebase-config.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <!-- 登录/注册界面 -->
    <div id="auth-container" class="fixed inset-0 bg-white dark:bg-black bg-opacity-100 dark:bg-opacity-100 flex items-center justify-center p-4 z-50">
        <div class="apple-card rounded-xl shadow-lg w-full max-w-md">
            <div class="p-8 space-y-6">
                <div class="text-center">
                    <h2 class="text-2xl font-semibold">欢迎使用定时任务工具</h2>
                    <p class="text-color-secondary mt-2">请使用管理员提供的账号登录</p>
                </div>
                
                <div id="auth-error" class="hidden text-red-500 text-sm text-center"></div>
                
                <!-- 登录表单 -->
                <div id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-base font-medium text-color-secondary mb-2">邮箱</label>
                        <input type="email" id="login-email" class="form-input w-full rounded-lg text-base p-2" placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-base font-medium text-color-secondary mb-2">密码</label>
                        <input type="password" id="login-password" class="form-input w-full rounded-lg text-base p-2" placeholder="密码" required>
                    </div>
                    <div class="pt-2">
                        <button id="login-btn" class="btn btn-primary w-full">登录</button>
                    </div>
                    <!-- 移除注册按钮 -->
                </div>
                
                <!-- 注册表单已移除 -->
            </div>
        </div>
    </div>
    
    <!-- 主应用界面 -->

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <div id="user-info" class="absolute top-4 right-4 text-sm">
                <span id="user-email" class="mr-2"></span>
                <button id="logout-btn" class="text-blue-500 hover:underline">退出登录</button>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/" class="btn btn-secondary text-sm">← 返回首页</a>
                <div>
                    <h1 class="text-3xl font-bold">定时任务</h1>
                    <p class="text-lg text-color-secondary mt-1">所有时间均为北京时间</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">

                 <div id="theme-switcher" class="flex items-center space-x-1 bg-gray-200 dark:bg-gray-800 p-1 rounded-full">
                    <button onclick="setTheme('light')" type="button" id="theme-light-btn" class="p-1.5 rounded-full text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95a1 1 0 101.414 1.414l.707-.707a1 1 0 10-1.414-1.414l-.707.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg></button>
                    <button onclick="setTheme('dark')" type="button" id="theme-dark-btn" class="p-1.5 rounded-full text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button>
                    <button onclick="setTheme('system')" type="button" id="theme-system-btn" class="p-1.5 rounded-full text-gray-700 dark:text-gray-400 hover:bg-gray-300 dark:hover:bg-gray-700"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.5a.5.5 0 01.5.5v2.5a.5.5 0 01-1 0V4a.5.5 0 01.5-.5zM10 10a.5.5 0 01.5.5v2.5a.5.5 0 01-1 0V10.5a.5.5 0 01.5-.5zM5.707 5.707a.5.5 0 01.707 0l1.768 1.768a.5.5 0 11-.707.707L5.707 6.414a.5.5 0 010-.707zM12.525 11.818a.5.5 0 01.707 0l1.768 1.768a.5.5 0 11-.707.707l-1.768-1.768a.5.5 0 010-.707zM5.707 14.293a.5.5 0 010-.707l1.768-1.768a.5.5 0 11.707.707L6.414 14.293a.5.5 0 01-.707 0zM11.818 7.475a.5.5 0 010-.707l1.768-1.768a.5.5 0 11.707.707L12.525 7.475a.5.5 0 01-.707 0z"></path></svg></button>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="export-tasks-btn" class="btn btn-secondary text-sm">导出</button>
                    <input type="file" id="import-tasks-input" class="hidden" accept=".json">
                    <button id="import-tasks-btn" class="btn btn-secondary text-sm">导入</button>
                <button id="create-task-btn" class="btn btn-primary">创建任务</button>
                </div>
            </div>
        </header>

        <main id="task-list" class="space-y-4">
            <!-- 任务列表将在这里动态生成 -->
        </main>
    </div>

    <!-- 创建/编辑任务弹窗 (Modal) -->
    <div id="task-modal" class="hidden fixed inset-0 bg-white dark:bg-black bg-opacity-100 dark:bg-opacity-100 flex items-center justify-center p-4 z-50">
        <div class="apple-card rounded-xl shadow-lg w-full max-w-2xl max-h-full overflow-y-auto">
            <form id="task-form" class="p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 id="modal-title" class="text-2xl font-semibold">创建新任务</h2>
                    <button type="button" id="close-modal-btn" class="text-color-secondary hover:text-color-primary text-2xl font-bold">&times;</button>
                </div>
                <div id="form-fields"></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-btn" class="btn btn-secondary">取消</button>
                    <button type="submit" id="submit-btn" class="btn btn-primary">创建任务</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 设置 favicon 为 Material Symbols 的 design_services 图标
        (function(){
            function setFavicon(){
                try{
                    var size=64, c=document.createElement('canvas'); c.width=size; c.height=size; var ctx=c.getContext('2d');
                    function draw(){
                        ctx.clearRect(0,0,size,size);
                        ctx.fillStyle='#0a84ff';
                        ctx.textAlign='center'; ctx.textBaseline='middle';
                        ctx.font='48px "Material Symbols Outlined"';
                        ctx.fillText('design_services', size/2, size/2+2);
                        var url=c.toDataURL('image/png');
                        var link=document.querySelector('link[rel="icon"][data-dynamic="1"]');
                        if(!link){ link=document.createElement('link'); link.rel='icon'; link.type='image/png'; link.setAttribute('data-dynamic','1'); document.head.appendChild(link); }
                        link.href=url;
                    }
                    if(document.fonts && document.fonts.load){ document.fonts.load('48px "Material Symbols Outlined"').then(draw, draw); } else { setTimeout(draw, 300); }
                }catch(e){}
            }
            setFavicon();
        })();
    </script>
    <script>
        // 初始化 dayjs
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_weekday);
        dayjs.locale('zh-cn');
        dayjs.tz.setDefault("Asia/Shanghai");

        // --- DOM 元素获取 ---
        const taskListContainer = document.getElementById('task-list');
        const createTaskBtn = document.getElementById('create-task-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const submitBtn = document.getElementById('submit-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const formFieldsContainer = document.getElementById('form-fields');
        
        // 移除对旧按钮的引用

        // --- 共享表单模板 ---
        formFieldsContainer.innerHTML = `
            <div>
                <label for="task-name" class="block text-base font-medium text-color-secondary mb-2">任务名称</label>
                <input type="text" id="task-name" class="form-input w-full rounded-lg text-base p-2" placeholder="例如：每日数据同步" required>
            </div>
            <div>
                <label for="webhook-url" class="block text-base font-medium text-color-secondary mb-2">Webhook URL</label>
                <input type="url" id="webhook-url" class="form-input w-full rounded-lg text-base p-2" placeholder="https://qyapi.weixin.qq.com/..." required>
            </div>
            <div>
                <label for="request-method" class="block text-base font-medium text-color-secondary mb-2">请求方法</label>
                <select id="request-method" class="form-select w-full rounded-lg text-base p-2">
                    <option>POST</option><option>GET</option><option>PUT</option><option>DELETE</option>
                </select>
            </div>
            <div>
                <label for="request-body" class="block text-base font-medium text-color-secondary mb-2">请求体 (Request Body)</label>
                <textarea id="request-body" rows="3" class="form-input w-full rounded-lg text-base p-2" placeholder='例如：{"msgtype": "text", "text": {"content": "你好"}}'></textarea>
            </div>
            <div>
                <label class="block text-base font-medium text-color-secondary mb-2">定时规则</label>
                <select id="schedule-type-selector" class="form-select w-full rounded-lg text-base p-2">
                    <option value="simple">简单间隔</option>
                    <option value="advanced">高级定时 (类Cron)</option>
                </select>
            </div>
            <div id="simple-schedule-container">
                <label for="schedule-interval" class="block text-base font-medium text-color-secondary mb-2">执行频率</label>
                <input type="number" id="schedule-interval" class="form-input w-24 rounded-lg inline text-base p-2" value="5" min="1">
                <select id="schedule-unit" class="form-select w-32 rounded-lg inline text-base p-2">
                    <option value="minutes">分钟</option><option value="hours">小时</option><option value="days">天</option>
                </select>
            </div>
            <div id="advanced-schedule-container" class="hidden space-y-3">
                <div>
                    <label class="block text-base font-medium text-color-secondary mb-2">选择日期 (每周)</label>
                    <div class="grid grid-cols-4 gap-4 mt-2">
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="1"><span>一</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="2"><span>二</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="3"><span>三</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="4"><span>四</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="5"><span>五</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="6"><span>六</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" class="form-checkbox" name="weekday" value="0"><span>日</span></label>
                    </div>
                </div>
                <div>
                    <label for="schedule-time" class="block text-base font-medium text-color-secondary mb-2">执行时间</label>
                    <input type="time" id="schedule-time" class="form-input w-full rounded-lg text-base p-2" value="09:55">
                </div>
            </div>
        `;

        // --- Firebase 初始化 ---
        // 使用统一配置初始化 Firebase（由 /firebase-config.js 提供）
        firebase.initializeApp(window.__FIREBASE_CONFIG__);

        // --- 状态与数据 ---
        let currentUser = null;
        let tasks = [];
        let taskTimers = new Map();

        async function persistSessionToWorker(idToken){
            try{
                await fetch('/auth/session', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ idToken }) });
            }catch(e){ console.warn('会话同步失败', e); }
        }

        // --- 重写的主题切换逻辑 ---
        function setTheme(theme) {
            console.log('设置主题为:', theme);
            localStorage.setItem('theme', theme);

            const body = document.body;
            body.classList.remove('dark-theme', 'system-theme');

            if (theme === 'dark') {
                body.classList.add('dark-theme');
                applyModalTheme('dark');
            } else if (theme === 'system') {
                body.classList.add('system-theme');
                const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyModalTheme(isDarkMode ? 'dark' : 'light');
            } else {
                // light
                applyModalTheme('light');
            }

            // 更新按钮高亮状态
            updateButtonStates(theme);
        }
        
        function applyModalTheme(mode) {
            // 应用到任务弹窗
            const taskModal = document.getElementById('task-modal');
            const taskModalCard = taskModal.querySelector('.apple-card');
            
            // 应用到认证弹窗
            const authContainer = document.getElementById('auth-container');
            const authCard = authContainer.querySelector('.apple-card');
            
            if (mode === 'dark') {
                // 暗色主题的弹窗
                if (taskModal) {
                    taskModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                    if (taskModalCard) {
                        taskModalCard.style.backgroundColor = '#1c1c1e';
                        taskModalCard.style.color = '#ffffff';
                        taskModalCard.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                        
                        // 更新表单元素
                        const inputs = taskModalCard.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            input.style.backgroundColor = '#2c2c2e';
                            input.style.borderColor = '#5a5a5c';
                            input.style.color = '#ffffff';
                        });
                        
                        // 更新标签
                        const labels = taskModalCard.querySelectorAll('label');
                        labels.forEach(label => {
                            label.style.color = '#8d8d92';
                        });
                    }
                }
                
                // 认证弹窗暗色主题
                if (authContainer) {
                    authContainer.style.backgroundColor = '#000000';
                    if (authCard) {
                        authCard.style.backgroundColor = '#1c1c1e';
                        authCard.style.color = '#ffffff';
                        authCard.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                        
                        // 更新表单元素
                        const inputs = authCard.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            input.style.backgroundColor = '#2c2c2e';
                            input.style.borderColor = '#5a5a5c';
                            input.style.color = '#ffffff';
                        });
                        
                        // 更新标签
                        const labels = authCard.querySelectorAll('label');
                        labels.forEach(label => {
                            label.style.color = '#8d8d92';
                        });
                    }
                }
            } else {
                // 亮色主题的弹窗
                if (taskModal) {
                    taskModal.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                    if (taskModalCard) {
                        taskModalCard.style.backgroundColor = '#ffffff';
                        taskModalCard.style.color = '#1d1d1f';
                        taskModalCard.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        
                        // 更新表单元素
                        const inputs = taskModalCard.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            input.style.backgroundColor = '#f2f2f7';
                            input.style.borderColor = '#8e8e93';
                            input.style.color = '#1d1d1f';
                        });
                        
                        // 更新标签
                        const labels = taskModalCard.querySelectorAll('label');
                        labels.forEach(label => {
                            label.style.color = '#6e6e73';
                        });
                    }
                }
                
                // 认证弹窗亮色主题
                if (authContainer) {
                    authContainer.style.backgroundColor = '#f5f5f7';
                    if (authCard) {
                        authCard.style.backgroundColor = '#ffffff';
                        authCard.style.color = '#1d1d1f';
                        authCard.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                        
                        // 更新表单元素
                        const inputs = authCard.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            input.style.backgroundColor = '#f2f2f7';
                            input.style.borderColor = '#8e8e93';
                            input.style.color = '#1d1d1f';
                        });
                        
                        // 更新标签
                        const labels = authCard.querySelectorAll('label');
                        labels.forEach(label => {
                            label.style.color = '#6e6e73';
                        });
                    }
                }
            }
        }
        
        function updateButtonStates(activeTheme) {
            const lightBtn = document.getElementById('theme-light-btn');
            const darkBtn = document.getElementById('theme-dark-btn');
            const systemBtn = document.getElementById('theme-system-btn');
            
            // 移除所有活跃状态
            lightBtn.classList.remove('theme-btn-active');
            darkBtn.classList.remove('theme-btn-active');
            systemBtn.classList.remove('theme-btn-active');

            // 添加活跃状态
            if (activeTheme === 'light') {
                lightBtn.classList.add('theme-btn-active');
            } else if (activeTheme === 'dark') {
                darkBtn.classList.add('theme-btn-active');
            } else if (activeTheme === 'system') {
                systemBtn.classList.add('theme-btn-active');
            }
        }
        
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            console.log('初始化主题:', savedTheme);
            setTheme(savedTheme);
        }

        // --- 表单UI切换 ---
        const scheduleSelector = document.getElementById('schedule-type-selector');
        const simpleContainer = document.getElementById('simple-schedule-container');
        const advancedContainer = document.getElementById('advanced-schedule-container');
        scheduleSelector.addEventListener('change', (e) => {
            simpleContainer.classList.toggle('hidden', e.target.value === 'advanced');
            advancedContainer.classList.toggle('hidden', e.target.value === 'simple');
        });

        // --- 核心任务逻辑 ---
        function calculateNextRun(task) {
            let now = dayjs();
            if (task.scheduleType === 'advanced') {
                const [hour, minute] = task.time.split(':').map(Number);
                // 确保days数组存在且不为空
                if (!task.days || task.days.length === 0) {
                    // 默认设置为每天
                    task.days = ['0','1','2','3','4','5','6'];
                }
                const sortedDays = task.days.map(Number).sort();
                let nextRun = null;
                for (let i = 0; i < 7; i++) {
                    let potentialRun = now.add(i, 'day').hour(hour).minute(minute).second(0).millisecond(0);
                    if (sortedDays.includes(potentialRun.day()) && potentialRun.isAfter(now)) {
                        nextRun = potentialRun;
                        break;
                    }
                }
                if (!nextRun) {
                    // 确保sortedDays不为空
                    const nextWeekDay = sortedDays.length > 0 ? sortedDays[0] : 1; // 默认周一
                    nextRun = now.add(1, 'week').day(nextWeekDay).hour(hour).minute(minute).second(0).millisecond(0);
                }
                return nextRun.valueOf();
            } else {
                return now.add(task.interval, task.unit).valueOf();
            }
        }

        async function executeTask(task) {
            console.log(`[${dayjs().format('YYYY-MM-DD HH:mm:ss')}] 执行任务: ${task.name}`);
            try {
                await fetch(task.url, {
                    method: task.method,
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: task.method !== 'GET' ? task.body : null,
                });
                updateTaskStatus(task.id, '请求已发送 (无法验证响应)', '#f59e0b'); // yellow-500
            } catch (error) {
                console.error(`任务 ${task.name} 执行失败:`, error);
                updateTaskStatus(task.id, `网络错误: ${error.message}`, '#ef4444'); // red-500
            }
        }

        function scheduleNext(task) {
            if (!task.isActive) {
                console.log(`任务 ${task.name} 已停用，跳过调度`);
                return;
            }

            // 清除现有定时器
            if (taskTimers.has(task.id)) {
                clearTimeout(taskTimers.get(task.id));
                console.log(`清除任务 ${task.name} 的现有定时器`);
            }

            const timeToNextRun = Math.max(0, task.nextRun - Date.now());
            const nextRunTime = new Date(task.nextRun).toLocaleString();

            console.log(`调度任务 ${task.name}:`);
            console.log(`- 下次执行时间: ${nextRunTime}`);
            console.log(`- 距离执行还有: ${Math.round(timeToNextRun / 1000)} 秒`);

            // 如果时间间隔太长（超过24小时），使用较短的检查间隔
            const maxInterval = 24 * 60 * 60 * 1000; // 24小时
            const actualInterval = Math.min(timeToNextRun, maxInterval);

            const timerId = setTimeout(async () => {
                console.log(`定时器触发，准备执行任务: ${task.name}`);

                // 如果这是一个长间隔的检查，重新计算时间
                if (timeToNextRun > maxInterval) {
                    console.log(`长间隔任务 ${task.name} 重新调度`);
                    const currentTask = tasks.find(t => t.id === task.id);
                    if (currentTask && currentTask.isActive) {
                        scheduleNext(currentTask);
                    }
                    return;
                }

                // 执行任务
                await executeTask(task);
                const currentTask = tasks.find(t => t.id === task.id);
                if (currentTask && currentTask.isActive) {
                    currentTask.nextRun = calculateNextRun(currentTask);
                    console.log(`任务 ${task.name} 执行完成，下次执行: ${new Date(currentTask.nextRun).toLocaleString()}`);

                    // 只更新当前任务的UI，而不是重新渲染整个列表
                    updateTaskUI(currentTask.id);
                    if (currentUser) {
                        localStorage.setItem(getUserTaskKey(), JSON.stringify(tasks));
                    }
                    scheduleNext(currentTask);
                }
            }, actualInterval);

            taskTimers.set(task.id, timerId);
            console.log(`任务 ${task.name} 定时器已设置，ID: ${timerId}`);
        }

        // --- 弹窗 (Modal) 逻辑 ---
        function openModal(mode, taskId = null) {
            taskForm.dataset.mode = mode;
            taskForm.dataset.editingTaskId = taskId;

            // 应用当前主题到弹窗
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark') {
                applyModalTheme('dark');
            } else if (currentTheme === 'system') {
                const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyModalTheme(isDarkMode ? 'dark' : 'light');
            } else {
                applyModalTheme('light');
            }

            if (mode === 'create') {
                modalTitle.textContent = '创建新任务';
                submitBtn.textContent = '创建任务';
                taskForm.reset();
                scheduleSelector.dispatchEvent(new Event('change'));
            } else {
                modalTitle.textContent = '编辑任务';
                submitBtn.textContent = '保存更改';
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                document.getElementById('task-name').value = task.name;
                document.getElementById('webhook-url').value = task.url;
                document.getElementById('request-method').value = task.method;
                document.getElementById('request-body').value = task.body;
                scheduleSelector.value = task.scheduleType;
                scheduleSelector.dispatchEvent(new Event('change'));

                if (task.scheduleType === 'advanced') {
                    document.querySelectorAll('input[name="weekday"]').forEach(cb => {
                        cb.checked = task.days.includes(cb.value);
                    });
                    document.getElementById('schedule-time').value = task.time;
                } else {
                    document.getElementById('schedule-interval').value = task.interval;
                    document.getElementById('schedule-unit').value = task.unit;
                }
            }
            taskModal.classList.remove('hidden');
        }

        function closeModal() {
            taskModal.classList.add('hidden');
        }
        createTaskBtn.addEventListener('click', () => openModal('create'));
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        // --- 渲染与保存 ---
        function updateTaskUI(taskId) {
            const taskCard = document.querySelector(`.task-card[data-id="${taskId}"]`);
            if (!taskCard) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const nextRunEl = taskCard.querySelector('.next-run-time');
            if (nextRunEl) {
                nextRunEl.textContent = `下次: ${dayjs(task.nextRun).fromNow()} (${dayjs(task.nextRun).format('MM-DD HH:mm')})`;
            }
            
            const activeBtn = taskCard.querySelector('.toggle-active-btn');
            if (activeBtn) {
                activeBtn.textContent = task.isActive ? '暂停' : '启动';
            }
        }
        
        function updateTaskStatus(taskId, message, color) {
            const statusEl = document.querySelector(`.task-card[data-id="${taskId}"] .task-status`);
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = color;
            }
        }

        function renderTasks() {
            if (tasks.length === 0) {
                taskListContainer.innerHTML = `<div class="text-center py-16">
                    <h3 class="text-xl font-semibold">没有任务</h3>
                    <p class="text-color-secondary mt-2">点击“创建任务”来添加您的第一个定时任务。</p>
                </div>`;
                return;
            }
            taskListContainer.innerHTML = '';
            tasks.sort((a, b) => a.nextRun - b.nextRun).forEach(task => {
                const nextRunFromNow = dayjs(task.nextRun).fromNow();
                let scheduleText = '';
                if (task.scheduleType === 'advanced') {
                    const dayNames = ['日', '一', '二', '三', '四', '五', '六'];
                    const selectedDayNames = task.days.map(d => `周${dayNames[d]}`).join('、');
                    scheduleText = `${selectedDayNames} ${task.time}`;
                } else {
                    scheduleText = `每 ${task.interval} ${task.unit === 'minutes' ? '分钟' : task.unit === 'hours' ? '小时' : '天'}`;
                }
                const card = document.createElement('div');
                card.className = 'apple-card rounded-xl p-4 flex justify-between items-center';
                card.dataset.id = task.id;
                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-semibold text-lg">${task.name}</h3>
                        <p class="text-sm text-color-secondary mt-1">${scheduleText}</p>
                        <p class="text-xs mt-2 next-run-time" style="color: #0a84ff;">下次: ${nextRunFromNow} (${dayjs(task.nextRun).format('MM-DD HH:mm')})</p>
                        <p class="task-status text-xs text-color-secondary mt-1">等待执行...</p>
                    </div>
                    <div class="flex items-center space-x-2 flex-shrink-0">
                        <button class="edit-btn action-btn">编辑</button>
                        <button class="toggle-active-btn action-btn">${task.isActive ? '暂停' : '启动'}</button>
                        <button class="run-now-btn action-btn">立即触发</button>
                        <button class="debug-btn action-btn" style="background: #6366f1; color: white;">调试</button>
                        <button class="delete-btn action-btn text-red-500">删除</button>
                    </div>
                `;
                taskListContainer.appendChild(card);
            });
        }

        function checkStorageLimit() {
            try {
                const data = JSON.stringify(tasks);
                const sizeInMB = (new Blob([data]).size / 1024 / 1024).toFixed(2);
                if (sizeInMB > 4) { // 接近5MB限制
                    alert(`警告：存储数据已达${sizeInMB}MB，接近浏览器存储限制(5MB)。请考虑删除部分任务。`);
                    return sizeInMB;
                }
                return null;
            } catch (e) {
                console.error('存储检查失败:', e);
                return null;
            }
        }

        function saveAndRender() {
            const limitWarning = checkStorageLimit();
            if (currentUser) {
                localStorage.setItem(getUserTaskKey(), JSON.stringify(tasks));
            }
            renderTasks();
        }

        // --- 事件监听器 ---
        // 验证JSON格式是否有效
        function isValidJson(str) {
            try {
                if (str === '') return true;
                JSON.parse(str);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        function getTaskDataFromForm() {
            const scheduleType = document.getElementById('schedule-type-selector').value;
            const taskData = {
                name: document.getElementById('task-name').value,
                url: document.getElementById('webhook-url').value,
                method: document.getElementById('request-method').value,
                body: document.getElementById('request-body').value,
                scheduleType: scheduleType,
            };
            if (scheduleType === 'advanced') {
                taskData.days = Array.from(document.querySelectorAll('input[name="weekday"]:checked')).map(cb => cb.value);
                taskData.time = document.getElementById('schedule-time').value;
            } else {
                taskData.interval = parseInt(document.getElementById('schedule-interval').value);
                taskData.unit = document.getElementById('schedule-unit').value;
            }
            return taskData;
        }

        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mode = taskForm.dataset.mode;
            const taskData = getTaskDataFromForm();
            
            // 验证请求体JSON格式
            if (taskData.body && taskData.method !== 'GET' && !isValidJson(taskData.body)) {
                alert('请求体不是有效的JSON格式！');
                return;
            }

            if (taskData.scheduleType === 'advanced' && taskData.days.length === 0) {
                alert('请至少选择一个执行日期！');
                return;
            }

            if (mode === 'create') {
                const newTask = {
                    ...taskData,
                    id: Date.now(),
                    isActive: true,
                    createdAt: Date.now(),
                };
                newTask.nextRun = calculateNextRun(newTask);
                tasks.push(newTask);
                scheduleNext(newTask);
            } else {
                const taskId = Number(taskForm.dataset.editingTaskId);
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                    tasks[taskIndex].nextRun = calculateNextRun(tasks[taskIndex]);
                    scheduleNext(tasks[taskIndex]);
                }
            }
            
            saveAndRender();
            closeModal();
        });

        taskListContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const card = button.closest('.apple-card');
            if (!card) return;
            
            const taskId = Number(card.dataset.id);
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const task = tasks[taskIndex];

            if (button.classList.contains('delete-btn')) {
                if (taskTimers.has(taskId)) clearTimeout(taskTimers.get(taskId));
                tasks.splice(taskIndex, 1);
                saveAndRender();
            } else if (button.classList.contains('toggle-active-btn')) {
                task.isActive = !task.isActive;
                if (task.isActive) {
                    task.nextRun = calculateNextRun(task);
                    scheduleNext(task);
                } else {
                    if (taskTimers.has(taskId)) clearTimeout(taskTimers.get(taskId));
                }
                saveAndRender();
            } else if (button.classList.contains('run-now-btn')) {
                executeTask(task);
            } else if (button.classList.contains('edit-btn')) {
                openModal('edit', taskId);
            } else if (button.classList.contains('debug-btn')) {
                showTaskDebugInfo(task);
            }
        });

        // --- 调试功能 ---
        function showTaskDebugInfo(task) {
            const hasTimer = taskTimers.has(task.id);
            const timerId = taskTimers.get(task.id);
            const nextRunTime = new Date(task.nextRun).toLocaleString();
            const timeToNext = Math.round((task.nextRun - Date.now()) / 1000);

            const debugInfo = `
任务调试信息：${task.name}

基本信息：
- 任务ID: ${task.id}
- 状态: ${task.isActive ? '启用' : '停用'}
- 创建时间: ${new Date(task.createdAt).toLocaleString()}

调度信息：
- 调度类型: ${task.scheduleType === 'advanced' ? '高级定时' : '简单间隔'}
- 下次执行: ${nextRunTime}
- 距离执行: ${timeToNext > 0 ? timeToNext + ' 秒' : '已过期'}

定时器状态：
- 定时器存在: ${hasTimer ? '是' : '否'}
- 定时器ID: ${timerId || '无'}
- 页面可见: ${document.visibilityState}
- 窗口焦点: ${document.hasFocus() ? '是' : '否'}

请求配置：
- URL: ${task.url}
- 方法: ${task.method}
- 请求体: ${task.body || '无'}

${task.scheduleType === 'advanced' ?
`高级配置：
- 执行日期: ${task.days?.map(d => ['日','一','二','三','四','五','六'][d]).join('、') || '无'}
- 执行时间: ${task.time}` :
`简单配置：
- 间隔: ${task.interval}
- 单位: ${task.unit}`}
            `;

            alert(debugInfo);
        }

        // --- 导入导出功能 ---
        function exportTasks() {
            const dataStr = JSON.stringify(tasks, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'webhook-tasks.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function importTasks(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedTasks = JSON.parse(e.target.result);
                    if (Array.isArray(importedTasks)) {
                        // 清除现有的计时器
                        taskTimers.forEach((timerId) => clearTimeout(timerId));
                        taskTimers.clear();
                        
                        // 导入任务并重新计算下次运行时间
                        tasks = importedTasks.map(task => {
                            // 确保导入的任务有正确的下次运行时间
                            if (task.isActive) {
                                task.nextRun = calculateNextRun(task);
                            }
                            return task;
                        });
                        
                        // 保存并重新调度所有任务
                        if (currentUser) {
                            localStorage.setItem(getUserTaskKey(), JSON.stringify(tasks));
                        }
                        renderTasks();
                        tasks.forEach(task => {
                            if (task.isActive) scheduleNext(task);
                        });
                        
                        alert('任务导入成功！');
                    } else {
                        alert('导入文件格式错误！');
                    }
                } catch (error) {
                    console.error('导入失败:', error);
                    alert('导入失败: ' + error.message);
                }
                // 重置文件输入框，以便可以再次导入同一文件
                document.getElementById('import-tasks-input').value = '';
            };
            reader.readAsText(file);
        }
        
        // 绑定导入导出按钮事件
        document.getElementById('export-tasks-btn').addEventListener('click', exportTasks);
        document.getElementById('import-tasks-btn').addEventListener('click', () => {
            document.getElementById('import-tasks-input').click();
        });
        document.getElementById('import-tasks-input').addEventListener('change', importTasks);

        // --- 认证相关函数 ---
        function showAuthError(message) {
            const errorEl = document.getElementById('auth-error');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }
        
        function hideAuthError() {
            document.getElementById('auth-error').classList.add('hidden');
        }
        
        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            hideAuthError();
        }
        
        function showAuthContainer() {
            document.getElementById('auth-container').classList.remove('hidden');
            applyModalTheme(localStorage.getItem('theme') === 'dark' ? 'dark' : 'light');
        }
        
        function hideAuthContainer() {
            document.getElementById('auth-container').classList.add('hidden');
        }
        
        function updateUserUI() {
            if (currentUser) {
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-info').classList.remove('hidden');
            } else {
                document.getElementById('user-info').classList.add('hidden');
            }
        }
        
        async function loginUser(email, password) {
            try {
                hideAuthError();
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                try{ const idToken = await currentUser.getIdToken(true); await persistSessionToWorker(idToken); }catch(e){}
                console.log('用户登录成功:', currentUser.email);
                hideAuthContainer();
                loadUserTasks();
                updateUserUI();
            } catch (error) {
                console.error('登录失败:', error);
                showAuthError(getAuthErrorMessage(error.code));
            }
        }
        
        // 注册功能已移除，由管理员在Firebase控制台创建用户
        
        async function logoutUser() {
            try {
                // 清除计时器
                taskTimers.forEach(timerId => clearTimeout(timerId));
                taskTimers.clear();
                
                await firebase.auth().signOut();
                currentUser = null;
                tasks = [];
                renderTasks();
                showAuthContainer();
                showLoginForm();
                updateUserUI();
                // 同步清理服务端会话
                window.location.href = '/auth/logout';
            } catch (error) {
                console.error('登出失败:', error);
            }
        }
        
        function getAuthErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email':
                    return '无效的电子邮箱格式';
                case 'auth/user-disabled':
                    return '该用户账号已被禁用';
                case 'auth/user-not-found':
                    return '用户不存在';
                case 'auth/wrong-password':
                    return '密码错误';
                case 'auth/email-already-in-use':
                    return '该邮箱已被注册';
                case 'auth/weak-password':
                    return '密码强度太弱，至少需要6位字符';
                default:
                    return `认证错误: ${errorCode}`;
            }
        }
        
        // --- 用户数据管理 ---
        // 使用更稳定的 key（基于邮箱），并向后兼容旧的 UID key
        function getStableUserKey() {
            const email = (currentUser?.email || '').toLowerCase();
            return `webhook_tasks_v2_${email}`;
        }
        function getLegacyUserKey() {
            return `webhook_tasks_${currentUser?.uid}`;
        }
        function getUserTaskKey() {
            return getStableUserKey();
        }
        function migrateLegacyTasksIfNeeded() {
            if (!currentUser) return;
            try {
                const stableKey = getStableUserKey();
                const legacyKey = getLegacyUserKey();
                const hasStable = !!localStorage.getItem(stableKey);
                if (hasStable) return;

                // 1) 先尝试从旧 UID key 迁移
                const legacyJson = localStorage.getItem(legacyKey);
                if (legacyJson) {
                    localStorage.setItem(stableKey, legacyJson);
                    return;
                }

                // 2) 扫描所有可能的旧 key（webhook_tasks_*），选择任务数量最多的作为迁移来源
                let bestKey = null;
                let bestCount = -1;
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (!k || !k.startsWith('webhook_tasks_')) continue;
                    try {
                        const arr = JSON.parse(localStorage.getItem(k));
                        if (Array.isArray(arr) && arr.length > bestCount) {
                            bestCount = arr.length;
                            bestKey = k;
                        }
                    } catch {}
                }
                if (bestKey) {
                    localStorage.setItem(stableKey, localStorage.getItem(bestKey));
                }
            } catch (e) {
                console.warn('任务迁移失败:', e);
            }
        }
        
        function loadUserTasks() {
            if (!currentUser) return;
            
            // 清除现有计时器
            taskTimers.forEach(timerId => clearTimeout(timerId));
            taskTimers.clear();
            
            // 加载用户特定的任务（支持迁移）
            migrateLegacyTasksIfNeeded();
            const tasksJson = localStorage.getItem(getUserTaskKey());
            tasks = tasksJson ? JSON.parse(tasksJson) : [];
            
            // 初始化任务计时器
            tasks.forEach(task => {
                if (task.isActive && Date.now() > task.nextRun) {
                    task.nextRun = calculateNextRun(task);
                }
                scheduleNext(task);
            });
            
            renderTasks();
        }
        
        function saveAndRender() {
            if (currentUser) {
                const limitWarning = checkStorageLimit();
                localStorage.setItem(getUserTaskKey(), JSON.stringify(tasks));
                renderTasks();
            }
        }
        
        // --- 页面可见性检测和定时器恢复 ---
        function setupVisibilityHandling() {
            // 监听页面可见性变化
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    console.log('页面重新可见，检查并恢复定时器');
                    restoreTimers();
                } else {
                    console.log('页面隐藏，定时器可能被浏览器限制');
                }
            });

            // 监听窗口焦点变化
            window.addEventListener('focus', () => {
                console.log('窗口获得焦点，恢复定时器');
                restoreTimers();
            });

            // 定期检查定时器状态（每分钟）
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    checkAndRestoreTimers();
                }
            }, 60000);
        }

        function restoreTimers() {
            console.log('开始恢复定时器...');
            tasks.forEach(task => {
                if (task.isActive) {
                    // 检查是否错过了执行时间
                    if (Date.now() > task.nextRun) {
                        console.log(`任务 ${task.name} 错过了执行时间，重新计算`);
                        task.nextRun = calculateNextRun(task);
                    }
                    scheduleNext(task);
                }
            });
            if (currentUser) {
                localStorage.setItem(getUserTaskKey(), JSON.stringify(tasks));
            }
            renderTasks();
        }

        function checkAndRestoreTimers() {
            let needsRestore = false;
            tasks.forEach(task => {
                if (task.isActive && !taskTimers.has(task.id)) {
                    console.log(`发现任务 ${task.name} 缺少定时器，需要恢复`);
                    needsRestore = true;
                }
            });

            if (needsRestore) {
                console.log('检测到缺失的定时器，执行恢复');
                restoreTimers();
            }
        }

        // --- 初始化 ---
        function initialize() {
            // 初始化主题
            initializeTheme();
            console.log('主题初始化完成');

            // 设置页面可见性处理
            setupVisibilityHandling();
            
            // 监听认证状态变化
            firebase.auth().onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    try{ const idToken = await user.getIdToken(true); await persistSessionToWorker(idToken); }catch(e){}
                    hideAuthContainer();
                    loadUserTasks();
                    updateUserUI();
                } else {
                    currentUser = null;
                    tasks = [];
                    renderTasks();
                    showAuthContainer();
                    showLoginForm();
                    updateUserUI();
                }
            });
            
            // 绑定认证相关事件
            document.getElementById('login-btn').addEventListener('click', () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                if (!email || !password) {
                    showAuthError('请填写邮箱和密码');
                    return;
                }
                loginUser(email, password);
            });
            
            // 注册相关事件监听已移除
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            // 应用当前主题到登录界面
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark' || (currentTheme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                applyModalTheme('dark');
            } else {
                applyModalTheme('light');
            }
        }

        initialize();
    </script>
</body>
</html>